name: Update Poetry lock

on:
  workflow_dispatch:

concurrency:
  group: poetry-lock
  cancel-in-progress: true

jobs:
  lock-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v5
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Configure Git
        run: |
          git config --local user.name  "poetryâ€‘lock bot"
          git config --local user.email "poetry-lock[bot]@users.noreply.github.com"
          if gpg --list-secret-keys &>/dev/null; then
            git config --local commit.gpgsign true
            git config --local user.signingkey $(gpg --list-secret-keys --with-colons | awk -F: '/^sec/ {print $5; exit}')
          fi

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Load cached Poetry installation
        id: cached-poetry
        uses: actions/cache@v4
        with:
          path: ~/.local
          key: poetry-v1
      - name: Install Poetry
        if: steps.cached-poetry.outputs.cache-hit != 'true'
        uses: snok/install-poetry@v1
        with:
          version: 2.1.3
          installer-parallel: true
        env:
          POETRY_VIRTUALENVS_CREATE: "false"

      - name: Regenerate poetry.lock
        run: poetry lock --no-ansi --no-interaction

      - name: Create or update Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'Update poetry.lock'
          branch: workflow/update-poetry-lock
          title: 'Update poetry.lock'
          body: |
            This pull request was automatically generated by the **updateâ€‘poetryâ€‘lock** workflow.
            It refreshes the lock file with the latest dependency versions specified in *pyproject.toml*.
          delete-branch:  true

      - name: Postâ€‘run summary
        run: |
          if [[ -z "${{ steps.cpr.outputs.pull-request-number }}" ]]; then
            echo "âœ… poetry.lock already upâ€‘toâ€‘date â€“ no PR created."
          else
            echo "ðŸ“Œ Created or updated PR #${{ steps.cpr.outputs.pull-request-number }}."
          fi
